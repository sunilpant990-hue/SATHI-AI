<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI Sathi ‚Äî Friendly Student AI</title>
<link rel="icon" href="https://i.ibb.co/6XJ5sBX/robot-logo.png">
<style>
  :root{
    --bg:#f6fbff; --card:#ffffff; --accent:#0b63ff; --muted:#6b7280; --text:#0b1220; --user:#0b63ff; --bot-bg:#eef7ff;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:linear-gradient(180deg,#f0f7ff 0%, #f6fbff 100%);color:var(--text);padding:20px;display:flex;justify-content:center;}
  .app{width:980px;max-width:100%;display:flex;gap:20px;align-items:flex-start;}
  .panel{width:340px;background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 24px rgba(15,23,42,0.08);}
  .logo-row{display:flex;gap:12px;align-items:center} .logo-row img{width:64px;height:64px;border-radius:12px;object-fit:cover}
  .logo-row h1{margin:0;font-size:20px} .founder{margin-top:8px;color:var(--muted);font-size:13px}
  .about{margin-top:12px;color:#123;line-height:1.45;font-size:14px}
  .actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(10,20,40,0.06);background:transparent;cursor:pointer;font-weight:600;color:var(--text)}
  .btn.primary{background:var(--accent);color:white;border:0}
  .small{font-size:13px;color:var(--muted);margin-top:10px}
  .chat-wrap{flex:1;display:flex;flex-direction:column;gap:12px}
  .chat-top{display:flex;justify-content:space-between;align-items:center}
  .title{font-weight:700;font-size:18px} .subtitle{color:var(--muted);font-size:13px}
  .chat-window{background:transparent;border-radius:12px;padding:16px;height:620px;display:flex;flex-direction:column;box-shadow:0 10px 26px rgba(15,23,42,0.06);}
  .messages{flex:1;display:flex;flex-direction:column;gap:12px;overflow:auto;padding:10px;background:linear-gradient(180deg, rgba(255,255,255,0.8), rgba(250,252,255,0.6));border-radius:10px;}
  .msg-row{display:flex;gap:10px;align-items:flex-end}
  .avatar{width:40px;height:40px;border-radius:8px;flex:0 0 40px;object-fit:cover}
  .bubble{max-width:72%;padding:10px 12px;border-radius:12px;line-height:1.3;font-size:14px;position:relative;box-shadow:0 6px 18px rgba(12,18,46,0.04);}
  .bubble.bot{background:var(--bot-bg);color:var(--text);border:1px solid rgba(11,99,255,0.04);align-self:flex-start;}
  .bubble.user{background:linear-gradient(90deg,var(--user),#0066ff);color:white;align-self:flex-end;border:0;margin-left:auto;}
  .meta{display:block;font-size:11px;color:var(--muted);margin-top:8px}
  .controls{display:flex;gap:8px;align-items:center;margin-top:12px}
  .input-box{flex:1;display:flex;gap:8px;align-items:center;background:var(--card);padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
  .input-box input{width:100%;border:0;background:transparent;outline:none;color:var(--text);font-size:14px;padding:8px}
  .icon-btn{width:44px;height:44px;border-radius:10px;border:0;background:var(--accent);color:white;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .sec-btn{width:44px;height:44px;border-radius:10px;background:#fff;border:1px solid rgba(10,20,40,0.06);cursor:pointer}
  .typing{display:inline-flex;gap:6px;align-items:center;padding:8px 10px;border-radius:10px;background:rgba(11,99,255,0.06)}
  .dot{width:8px;height:8px;border-radius:50%;background:var(--muted);animation:blink 1s infinite}
  .dot.d1{animation-delay:0s}.dot.d2{animation-delay:.12s}.dot.d3{animation-delay:.24s}
  @keyframes blink{0%{opacity:.2}50%{opacity:1}100%{opacity:.2}}
  .tools{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  @media (max-width:980px){ .app{flex-direction:column;align-items:center} .panel{width:100%} .chat-wrap{width:100%} .chat-window{height:70vh} }
</style>
</head>
<body>

<div class="app">
  <div class="panel">
    <div class="logo-row">
      <img src="https://i.ibb.co/6XJ5sBX/robot-logo.png" alt="AI Sathi Logo">
      <div>
        <h1>AI Sathi (‡§∏‡§æ‡§•‡•Ä)</h1>
        <p style="margin:0;color:var(--muted)">Friendly Student AI ‚Äî Founder: Sunil Pant</p>
      </div>
    </div>

    <div class="founder">Created by <strong>Sunil Pant</strong></div>

    <div class="about">
      AI Sathi supports Nepali students with exam stress, time-management, sleep tips, confidence-building and study strategies. This demo is offline-first and proof-ready for college applications.
    </div>

    <div class="actions">
      <button class="btn primary" id="saveBtn">Save Chat</button>
      <button class="btn" id="downloadBtn">Download</button>
      <button class="btn" id="copyBtn">Copy</button>
      <button class="btn" id="restoreBtn">Restore</button>
      <button class="btn" id="clearLocalBtn">Delete Saved</button>
    </div>

    <div class="small">Mic note: microphone works best in Chrome/Brave and when hosted over HTTPS (GitHub Pages). Save your chat to prove impact for applications.</div>
  </div>

  <div class="chat-wrap">
    <div class="chat-top">
      <div>
        <div class="title">AI Sathi ‚Äî Student Support</div>
        <div class="subtitle">Friendly ‚Ä¢ Nepali & English ‚Ä¢ Proof-ready</div>
      </div>
      <div style="font-size:13px;color:var(--muted)" id="micIndicator">Mic: checking‚Ä¶</div>
    </div>

    <div class="chat-window">
      <div id="messages" class="messages" role="log" aria-live="polite"></div>

      <div class="controls">
        <div class="input-box">
          <input id="input" placeholder="Type or say: exam, pressure, nindra audaina, solve 3+5, joke..." />
        </div>
        <button class="sec-btn" id="micBtn" title="Start/Stop microphone">üé§</button>
        <button class="icon-btn" id="sendBtn" title="Send message">‚û§</button>
      </div>

      <div class="tools" style="margin-top:10px">
        <button class="btn" id="btnExample">Examples</button>
        <button class="btn" id="btnClear">Clear Chat</button>
        <button class="btn" id="btnExport">Export JSON</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== AI Sathi ‚Äî Friendly (clean, robust) =====
   - Replaces previous scripts
   - Generates many replies using templates (no external API)
   - Intent detection + safe math
   - Typing indicator + timestamp
   - Save/restore/download/copy/export JSON
   - Mic support (requires HTTPS to work reliably)
*/

/* ---------- DOM ---------- */
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('input');
const sendBtn = document.getElementById('sendBtn');
const micBtn = document.getElementById('micBtn');
const micIndicator = document.getElementById('micIndicator');
const saveBtn = document.getElementById('saveBtn');
const downloadBtn = document.getElementById('downloadBtn');
const copyBtn = document.getElementById('copyBtn');
const restoreBtn = document.getElementById('restoreBtn');
const clearLocalBtn = document.getElementById('clearLocalBtn');
const btnExample = document.getElementById('btnExample');
const btnClear = document.getElementById('btnClear');
const btnExport = document.getElementById('btnExport');

/* ---------- Utilities ---------- */
function now(){ return new Date().toLocaleString(); }
function avatarImg(who){ return who==='bot' ? 'https://i.ibb.co/6XJ5sBX/robot-logo.png' : 'https://i.ibb.co/0G0Gm8W/user-avatar.png'; }
function pushMessage(text, who='bot', meta=true){
  const row = document.createElement('div'); row.className='msg-row';
  const av = document.createElement('img'); av.className='avatar'; av.src = avatarImg(who);
  const bubble = document.createElement('div'); bubble.className='bubble ' + (who==='user' ? 'user' : 'bot');
  bubble.innerHTML = escapeHtml(text) + (meta ? `<div class="meta">${who==='user' ? 'You' : 'AI Sathi'} ‚Ä¢ ${now()}</div>` : '');
  if(who==='user'){ row.appendChild(bubble); row.appendChild(av); bubble.style.marginLeft='auto'; } else { row.appendChild(av); row.appendChild(bubble); }
  messagesEl.appendChild(row); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function escapeHtml(str){ return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function showTyping(){
  const row=document.createElement('div'); row.className='msg-row';
  row.innerHTML = `<img class="avatar" src="${avatarImg('bot')}"><div class="typing"><div class="dot d1"></div><div class="dot d2"></div><div class="dot d3"></div></div>`;
  messagesEl.appendChild(row);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  return row;
}
function rm(el){ if(el && el.parentNode) el.parentNode.removeChild(el); }

/* ---------- Generate reply pool (templates) ---------- */
const englishPrefixes = ["Don't worry ‚Äî","Hey, I got you!","It's okay,","Take a breath ‚Äî","I understand ‚Äî","You're not alone ‚Äî","Relax,","That's normal ‚Äî","I hear you ‚Äî","Nice one ‚Äî"];
const englishBodies = ["try breaking your study into 25-min focused sessions.","take a 5-minute walk, it helps a lot.","try active recall: read, close book, recall.","talk to one friend or teacher and tell them how you feel.","start with the easiest task and build momentum.","write down three small wins from today.","set a simple plan for the next hour and follow it.","do a short breathing exercise right now.","drink water and rest your eyes for a bit.","practice past papers under timed conditions."];
const nepaliPrefixes = ["‡§°‡§∞ ‡§®‡§≤‡§ø‡§®‡•Å‡§∏ ‚Äî","‡§∏‡§æ‡§•‡•Ä,","‡§†‡•Ä‡§ï ‡§õ ‚Äî","‡§è‡§ï ‡§∏‡§æ‡§∏ ‡§≤‡§ø‡§®‡•Å‡§∏ ‚Äî","‡§Æ ‡§¨‡•Å‡§ù‡•ç‡§õ‡•Å ‚Äî","‡§§‡§ø‡§Æ‡•Ä ‡§è‡§ï‡•ç‡§≤‡•à ‡§π‡•ã‡§á‡§® ‚Äî","‡§Ü‡§∞‡§æ‡§Æ ‡§ó‡§®‡•Å‡§∏ ‚Äî","‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ï‡•Å‡§∞‡§æ ‡§π‡•ã ‚Äî","‡§Æ ‡§∏‡•Å‡§®‡§ø‡§∞‡§π‡•á‡§ï‡•ã ‡§õ‡•Å ‚Äî","‡§∏‡•Å‡§∞‡•Å ‡§ó‡§∞ ‚Äî"];
const nepaliBodies = ["‡•®‡•´ ‡§Æ‡§ø‡§®‡•á‡§ü ‡§™‡§¢‡•á‡§∞ ‡•´ ‡§Æ‡§ø‡§®‡•á‡§ü ‡§µ‡§ø‡§∂‡•ç‡§∞‡§æ‡§Æ ‡§ó‡§∞‡•§","‡§•‡•ã‡§∞‡•à ‡§π‡§ø‡§Å‡§°‡•ç‡§® ‡§ú‡§æ‡§â, ‡§ß‡•á‡§∞‡•à ‡§Æ‡§¶‡•ç‡§¶‡§§ ‡§ó‡§∞‡•ç‡§õ‡•§","‡§è‡§ï‡•ç‡§ü‡§ø‡§≠ ‡§∞‡§ø‡§ï‡•â‡§≤ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ó‡§∞: ‡§™‡§¢, ‡§∏‡§Æ‡•ç‡§ù, ‡§≤‡•á‡§ñ‡•§","‡§è‡§ï ‡§ú‡§®‡§æ ‡§∏‡§æ‡§•‡•Ä ‡§µ‡§æ ‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§™‡§ï‡§∏‡§Å‡§ó ‡§ï‡•Å‡§∞‡§æ ‡§ó‡§∞‡•§","‡§∏‡§æ‡§®‡§æ ‡§ï‡§æ‡§Æ‡§¨‡§æ‡§ü ‡§∏‡•Å‡§∞‡•Å ‡§ó‡§∞, ‡§Æ‡§®‡•ã‡§¨‡§≤ ‡§¨‡§¢‡•ç‡§õ‡•§","‡§Ü‡§ú‡§ï‡§æ ‡•© ‡§µ‡§ü‡§æ ‡§∏‡§æ‡§®‡§æ ‡§∏‡§´‡§≤‡§§‡§æ‡§π‡§∞‡•Ç ‡§≤‡•á‡§ñ‡•§","‡§Ö‡§π‡§ø‡§≤‡•á ‡§∏‡§æ‡§®‡•ã ‡§¨‡•ç‡§∞‡•á‡§•‡§ø‡§ô ‡§è‡§ï‡•ç‡§∏‡§∞‡§∏‡§æ‡§á‡§ú ‡§ó‡§∞‡•§","‡§™‡§æ‡§®‡•Ä ‡§™‡§ø‡§â ‡§∞ ‡§Ü‡§Å‡§ñ‡§æ‡§≤‡§æ‡§à ‡§µ‡§ø‡§∂‡•ç‡§∞‡§æ‡§Æ ‡§¶‡•á‡§ä‡•§","‡§Ö‡§ò‡§ø‡§≤‡•ç‡§≤‡§æ ‡§™‡•á‡§™‡§∞‡§π‡§∞‡•Ç ‡§∏‡§Æ‡§Ø‡§ï‡•ã ‡§∏‡§æ‡§• ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§ó‡§∞‡•§","‡§ß‡•á‡§∞‡•à ‡§ö‡§ø‡§®‡•ç‡§§‡§æ ‡§≠‡§è ‡§∏‡§æ‡§®‡§æ ‡§ï‡§¶‡§Æ ‡§≤‡§ø‡§ä‡§Å‡•§"];
const closers = ["You got this! üí™","I believe in you.","One step at a time.","Tell me how it goes!","I‚Äôm right here with you.","We‚Äôll try again together.","Keep going ‚Äî small steps win.","I‚Äôm proud of your effort.","Stay strong, friend.","Text me anytime."];
const nepaliClosers = ["‡§§‡§ø‡§Æ‡•Ä‡§≤‡•á ‡§ó‡§∞‡•ç‡§ú‡•ç‡§Ø‡•å! üí™","‡§Æ ‡§§‡§ø‡§Æ‡•Ä‡§Æ‡§æ‡§•‡§ø ‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ‡§∏ ‡§ó‡§∞‡•ç‡§õ‡•Å‡•§","‡§è‡§ï ‡§ï‡§¶‡§Æ ‡§è‡§ï‡§ö‡•ã‡§ü‡§ø‡•§","‡§ï‡§∏‡§∞‡•Ä ‡§≠‡§Ø‡•ã ‡§≠‡§®‡•Ä ‡§¨‡§§‡§æ‡§â!","‡§Æ ‡§∏‡§ß‡•à‡§Ç ‡§õ‡•Å‡§Å‡•§","‡§´‡•á‡§∞‡•Ä ‡§∏‡§Ç‡§ó‡•à ‡§ó‡§∞‡•å‡§Å‡§≤‡§æ‡•§","‡§∏‡§æ‡§®‡•ã ‡§ï‡§¶‡§Æ‡§≤‡•á ‡§†‡•Ç‡§≤‡•ã ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§≤‡•ç‡§Ø‡§æ‡§â‡§Å‡§õ‡•§","‡§§‡§ø‡§Æ‡•ç‡§∞‡•ã ‡§Æ‡•á‡§π‡§®‡§§‡§Æ‡§æ ‡§ó‡§∞‡•ç‡§µ ‡§õ‡•§","‡§¶‡•É‡§¢ ‡§∞‡§π‡§®‡•Å ‡§∏‡§æ‡§•‡•Ä‡•§","‡§ú‡§¨ ‡§ö‡§æ‡§π‡•á ‡§≤‡•á‡§ñ‡•§"];

function buildPool(){
  const pool = [];
  for(const p of englishPrefixes){
    for(const b of englishBodies){
      for(let i=0;i<3;i++){
        pool.push(`${p} ${b} ${closers[(i)%closers.length]}`);
      }
    }
  }
  for(const p of nepaliPrefixes){
    for(const b of nepaliBodies){
      for(let i=0;i<3;i++){
        pool.push(`${p} ${b} ${nepaliClosers[i%nepaliClosers.length]}`);
      }
    }
  }
  // small extras & motivational lines
  const smalls = [
    "I'm here whenever you want to talk.",
    "Try focusing for 25 minutes, then reward yourself.",
    "A short nap can sometimes reset your focus.",
    "Break tasks into tiny steps and start.",
    "Breathing for one minute can calm your mind.",
    "Write down what worries you and tackle one item."
  ];
  pool.push(...smalls);
  pool.push(...nepaliBodies.map((b,i)=>`${nepaliPrefixes[i%nepaliPrefixes.length]} ${b} ${nepaliClosers[i%nepaliClosers.length]}`));
  const qas = [
    ["How to study for long exams?","Try spaced repetition and timed past papers. Study 50‚Äì60 mins with short breaks."],
    ["How to deal with family pressure?","Speak honestly with one family member, explain your plan, and ask for support."],
    ["I can't sleep before exams, help","Avoid screens 30 minutes before bed and try 4-4-4 breathing."],
    ["How to manage time?","Make a simple schedule with 25‚Äì50 minute study blocks and plan breaks."],
    ["How to build confidence?","Practice small tasks daily and celebrate tiny wins."]
  ];
  for(const [q,a] of qas){ pool.push(`${q} ‚Äî ${a}`); pool.push(`${a} (${["Try it","Give it a go","Start small"][Math.floor(Math.random()*3)]})`); }
  // ensure many entries
  while(pool.length < 600) pool.push("Keep trying ‚Äî one step at a time. Tell me what's next.");
  return Array.from(new Set(pool));
}
const REPLY_POOL = buildPool();

/* ---------- Intent detection ---------- */
function detectIntent(text){
  const t = text.toLowerCase();
  const crisis = ["suicide","kill myself","i want to die","end my life","self harm","suicidal","marna","ma marna","aafai marna"];
  for(const k of crisis) if(t.includes(k)) return {intent:'crisis'};
  if(/\b(exam|test|finals|board)\b/.test(t)) return {intent:'exam'};
  if(/\b(stress|stressed|pressure|overwhelmed|dabav|dabab)\b/.test(t)) return {intent:'stress'};
  if(/\b(sleep|insomnia|nindra|sutana|nindra audaina)\b/.test(t)) return {intent:'sleep'};
  if(/\b(confidence|confident|doubt|bharosa|confidence kam)\b/.test(t)) return {intent:'confidence'};
  if(/\b(lonely|alone|eklo|ekla)\b/.test(t)) return {intent:'lonely'};
  if(/\b(motivate|motivation|inspire)\b/.test(t)) return {intent:'motivate'};
  if(/\b(joke|jokes)\b/.test(t)) return {intent:'joke'};
  if(/\b(fact|facts)\b/.test(t)) return {intent:'fact'};
  if(/\b(time|date|today|what time)\b/.test(t)) return {intent:'time'};
  if(/\b(solve|calculate|what is|[0-9]+\s*[\+\-\*\/])/.test(t)) return {intent:'math'};
  if(/\b(college|apply|application|admission|sat)\b/.test(t)) return {intent:'college'};
  if(/\b(hi|hello|namaste|hey)\b/.test(t)) return {intent:'greet'};
  return {intent:'fallback'};
}

/* ---------- Safe math ---------- */
function safeEval(expr){
  if(!/^[0-9\.\s\+\-\*\/\(\)]+$/.test(expr)) return {err:'Invalid characters.'};
  try{ const val = Function('"use strict";return ('+expr+')')(); if(typeof val==='number' && isFinite(val)) return {val}; return {err:'Invalid result.'}; } catch(e){ return {err:'Cannot evaluate.'}; }
}

/* ---------- Reply selection ---------- */
function replyForIntent(intent, text){
  if(intent==='crisis') return {text:"If you're thinking about harming yourself, please contact local emergency services and a trusted adult right now. This is an emergency.", urgent:true};
  if(intent==='math'){ const expr = text.replace(/[^0-9\.\+\-\*\/\(\)\s]/g,'').trim(); const r = safeEval(expr || text); if(r.err) return {text:"I couldn't solve that: "+r.err}; return {text:`Answer: ${r.val}`}; }
  if(intent==='exam'){ // choose replies mentioning study
    const picks = REPLY_POOL.filter(s => /study|exam|practice|paper|pomodoro|past/i.test(s));
    return {text: picks[Math.floor(Math.random()*picks.length)] || REPLY_POOL[Math.floor(Math.random()*REPLY_POOL.length)]};
  }
  if(intent==='stress'){ const picks = REPLY_POOL.filter(s=>/stress|pressure|breathe|breathing|relax|rest|calm|overwhelm/i.test(s)); return {text: picks[Math.floor(Math.random()*picks.length)]}; }
  if(intent==='sleep'){ const picks = REPLY_POOL.filter(s=>/sleep|nindra|bed|rest|nap/i.test(s)); return {text: picks[Math.floor(Math.random()*picks.length)] || "Try avoiding screens 30 min before bed and do 4-4-4 breathing."}; }
  if(intent==='confidence'){ const picks = REPLY_POOL.filter(s=>/confidence|win|small success|celebrate|practice/i.test(s)); return {text: picks[Math.floor(Math.random()*picks.length)] || "List 3 small wins and repeat."}; }
  if(intent==='lonely') return {text: REPLY_POOL[Math.floor(Math.random()*REPLY_POOL.length)]};
  if(intent==='motivate') return {text: REPLY_POOL[Math.floor(Math.random()*REPLY_POOL.length)]};
  if(intent==='joke') return {text:["Why do programmers prefer dark mode? Because light attracts bugs.","Why did the computer get cold? It left its Windows open."][Math.floor(Math.random()*2)]};
  if(intent==='fact') return {text:["Practice testing improves retention.","Active recall is more effective than rereading."][Math.floor(Math.random()*2)]};
  if(intent==='time') return {text:"Current time: "+new Date().toLocaleString()};
  if(intent==='college') return {text:"Show impact (users), code on GitHub, and a short demo video. I can help you write the activity paragraph."};
  if(intent==='greet') return {text:["Namaste! I'm AI Sathi ‚Äî how are you feeling?","Hey! I'm here ‚Äî tell me what's on your mind."][Math.floor(Math.random()*2)]};
  // fallback friendly reply
  return {text: REPLY_POOL[Math.floor(Math.random()*REPLY_POOL.length)]};
}

/* ---------- Send flow ---------- */
function sendText(text){
  const t = text && text.trim();
  if(!t) return;
  pushMessage(t, 'user');
  const typing = showTyping();
  setTimeout(()=>{
    rm(typing);
    const d = detectIntent(t);
    const bot = replyForIntent(d.intent, t);
    pushMessage(bot.text, 'bot');
    if(bot.urgent) setTimeout(()=> alert(bot.text), 200);
  }, 500 + Math.min(900, t.length*8));
}

/* UI events */
sendBtn.addEventListener('click', ()=>{ sendText(inputEl.value); inputEl.value=''; inputEl.focus(); });
inputEl.addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ sendText(inputEl.value); inputEl.value=''; } });

btnExample.addEventListener('click', ()=>{ const ex = ["exam","pressure","nindra audaina","solve 12/3","joke","fact","time","college"]; for(const q of ex){ pushMessage(q,'user',false); sendText(q); }});
btnClear.addEventListener('click', ()=>{ if(confirm('Clear chat on screen?')) messagesEl.innerHTML=''; });

/* ---------- Save / restore / download / copy ---------- */
saveBtn.addEventListener('click', ()=>{ localStorage.setItem('ai_sathi_chat', messagesEl.innerHTML); alert('Chat saved in browser storage.'); });
restoreBtn.addEventListener('click', ()=>{ const h = localStorage.getItem('ai_sathi_chat'); if(h){ messagesEl.innerHTML = h; messagesEl.scrollTop = messagesEl.scrollHeight; alert('Restored chat.'); } else alert('No saved chat found.'); });
clearLocalBtn.addEventListener('click', ()=>{ if(confirm('Delete saved chat?')){ localStorage.removeItem('ai_sathi_chat'); alert('Deleted saved chat.'); }});
downloadBtn.addEventListener('click', ()=>{ const txt = Array.from(messagesEl.querySelectorAll('.bubble')).map(b=>b.innerText.replace(/\n/g,' ')).join('\n\n'); const blob = new Blob([txt],{type:'text/plain'}); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ai_sathi_chat.txt'; a.click(); });
copyBtn.addEventListener('click', ()=>{ const txt = Array.from(messagesEl.querySelectorAll('.bubble')).map(b=>b.innerText.replace(/\n/g,' ')).join('\n\n'); navigator.clipboard.writeText(txt).then(()=> alert('Chat copied to clipboard.')); });
btnExport.addEventListener('click', ()=>{ const data={savedAt:new Date().toLocaleString(),content:Array.from(messagesEl.querySelectorAll('.bubble')).map(b=>b.innerText)}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='ai_sathi_chat.json'; a.click(); });

/* ---------- Microphone (SpeechRecognition) ---------- */
let recognition = null;
let listening = false;
function initMic(){
  if(!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)){ micIndicator.innerText='Mic: not supported'; micBtn.title='Mic not supported'; micBtn.style.opacity=0.6; return; }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = 'en-US';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.onstart = ()=>{ listening=true; micIndicator.innerText='Mic: listening... (click to stop)'; micBtn.style.background='#0b63ff'; }
  recognition.onend = ()=>{ listening=false; micIndicator.innerText='Mic: idle'; micBtn.style.background=''; }
  recognition.onerror = (e)=>{ listening=false; micIndicator.innerText='Mic: error'; console.warn('Mic error',e); }
  recognition.onresult = (ev)=>{ const spoken = ev.results[0][0].transcript; inputEl.value = spoken; sendText(spoken); inputEl.value=''; };
  micIndicator.innerText='Mic: ready (click mic)';
}
micBtn.addEventListener('click', ()=>{
  if(!recognition){ alert('Microphone not supported in this browser. Use Chrome/Brave and/or host the page on GitHub Pages to enable mic.'); return; }
  if(!listening){ try{ recognition.start(); } catch(e){ console.warn(e); } } else recognition.stop();
});

/* ---------- Init ---------- */
initMic();
setTimeout(()=> pushMessage("Namaste! I'm AI Sathi ‚Äî your friendly study & mental support buddy. Try: exam, pressure, nindra audaina, solve 3+5. Save chat for proof.", 'bot'), 300);

</script>
</body>
</html>
